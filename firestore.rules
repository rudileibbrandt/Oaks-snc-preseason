rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Roster: Anyone authenticated can read (for stat board), but only modify their own
    match /roster/{playerId} {
      // Anyone authenticated can read (for stat board)
      allow read: if request.auth != null;
      // Users can only create/update their own profile
      allow create: if request.auth != null && 
                    request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && 
                    resource.data.userId == request.auth.uid;
      // Deletes are not allowed from the app
      allow delete: if false;
    }
    
    // Logs: Anyone authenticated can read (for stat board), but only create/update their own
    match /logs/{logId} {
      // Anyone authenticated can read (for stat board)
      allow read: if request.auth != null;
      // Users can only create/update logs for their own playerId
      // Verify the playerId belongs to the user by checking the roster document
      allow create: if request.auth != null && 
                    request.resource.data.playerId != null &&
                    exists(/databases/$(database)/documents/roster/$(request.resource.data.playerId)) &&
                    get(/databases/$(database)/documents/roster/$(request.resource.data.playerId)).data.userId == request.auth.uid;
      allow update: if request.auth != null && 
                    resource.data.playerId != null &&
                    exists(/databases/$(database)/documents/roster/$(resource.data.playerId)) &&
                    get(/databases/$(database)/documents/roster/$(resource.data.playerId)).data.userId == request.auth.uid;
      // Deletes are not allowed from the app
      allow delete: if false;
    }
  }
}

